# WARNING: f6251 has a circular dependency on f1040.  f1040 line.12.b.whole
# depends on the final result, f6251 part.2.line.11.amt.whole.  However, f6251
# also depends on f1040.
# filing-status is a zero-based check box
filing.status:
  value: ctx.financial.filingStatus.toLowerCase()
  calculate: |
    (ctx, value) => {
      return {
        'single':                    { fill: '1', field: '0' },
        'married filing jointly':    { fill: '2', field: '1' },
        'married filing separately': { fill: '3', field: '2' },
        'head of household':         { fill: '4', field: '3' },
        'qualifying widow(er)':      { fill: '5', field: '4' }
      }[value];
    }

name.first.and.initial:
  6: ctx.firstName + ' ' + ctx.middleInitial

name.last:
  7: ctx.lastName

ssn.nodash:
  8: ctx.ssn

name.spouse.first:
  value: ctx.spouse
  calculate: |
    (ctx, value) => {
      if (!value) {
        return { fill: '', field: '9' };
      }
      return {
        fill: value.firstName + ' ' + value.middleInitial,
        field: '9'
      };
    }

name.spouse.last:
  value: ctx.spouse
  calculate: |
    (ctx, value) => {
      if (!value) {
        return { fill: '', field: '10' };
      }
      return {
        fill: value.lastName,
        field: '10'
      };
    }

ssn.spouse.nodash:
  value: ctx.spouse
  calculate: |
    (ctx, value) => {
      if (!value) {
        return { fill: '', field: '11' };
      }
      return {
        fill: value.ssn,
        field: '11'
      };
    }

address.street:
  12: ctx.address.street

address.apt:
  13: ctx.address.apt

address.city.zip:
  14: ctx.address.city + ' ' + ctx.address.postCode + ' ' + ctx.address.country

foreign.country.name:
  15: ctx.address.countryCode

foreign.province.county:
  16: ctx.address.county

foreign.postal.code:
  17: ctx.address.postCode

line.1.wages.salary.tips.whole:
  51: (ctx.financial.income / ctx.financial.averageExchangeRate)

line.7b.total.income.whole:
  # Add lines 1, 2b, 3b, 4b, 4d, 5b, 6, and 7a. This is your total income
  65: ctx.forms["f1040"]["line.1.wages.salary.tips.whole"]

line.8a.adjustments.to.income.schedule.1.whole:
  # Adjustments to income from Schedule 1, line 22
  66: 

line.8b.adjusted.gross.income.whole:
  # Subtract line 8a from line 7b. This is your adjusted gross income
  67: ctx.forms["f1040"]["line.7b.total.income.whole"]

line.9.standard.deduction.whole:
  # Single or Married filing separately, $12,200 
  # • Married filing jointly or Qualifying widow(er), $24,400
  # • Head of household, $18,350
  # • If you checked any box under Standard Deduction, see instructions.
  value: ctx.financial.filingStatus.toLowerCase()
  calculate: |
    (ctx, value) => {
      return {
        'single':                    { fill: 12200, field: '68' },
        'married filing separately': { fill: 12200, field: '68' },
        'married filing jointly':    { fill: 24400, field: '68' },
        'qualifying widow(er)':      { fill: 24400, field: '68' },
        'head of household':         { fill: 18350, field: '68' }
      }[value];
    }

line.11a.total.deductions.whole:
  # Add lines 9 and 10
  70: ctx.forms["f1040"]["line.9.standard.deduction.whole"]

line.11b.taxable.income.whole:
  71: Math.max(0,
          (ctx.forms["f1040"]["line.8b.adjusted.gross.income.whole"])
          - (ctx.forms["f1040"]["line.11a.total.deductions.whole"])
      )

line.12.a.tax.whole:
  # **NOTE**: For future reference, this value is key to unlocking the whole
  # thing.  This field is also used in f1116.  ** DO THIS FIRST **
  # This uses "Foreign Earned Income Tax Worksheet" and "Tax Computation
  # Worksheet".  However, if no deductions, etc. then, this value is
  # effectively the one computed using the Tax Computation Worksheet.
  # --------------------------------------------------------------------------
  # Foreign Tax (see int.)
  # I believe that if in the case of foreign earned income, you never want the
  # IRS to calculate your tax, so use the Foreign Earned Income Tax Worksheet.
  # > If you claimed the foreign earned income exclusion, housing exclusion,
  # > or housing deduction on Form 2555, you must figure your tax using the
  # > Foreign Earned Income Tax Worksheet.
  # On line 4 of the Foreign Earned Income Tax Worksheet
  # If income < 100,000 use the Tax Table
  # If income > 100,000 use the Tax Computation Worksheet
  #
  # TAX COMPUTATION WORKSHEET ("married filing separately") p74
  # Taxable income. If line 11b is          | 11b (a) | Multiply amt. (b) | a * b | minus       | =
  # ---------------------------------------------------------------------------------------------
  # At least $100,000 but not over $160,725 | $       | × 24% (0.24)      | $     | $ 5,825.50  | $
  # Over $160,725 but not over $204,100     | $       | × 32% (0.32)      | $     | $ 18,683.50 | $
  # Over $204,100 but not over $306,175     | $       | × 35% (0.35)      | $     | $ 24,806.50 | $
  # Over $306,175                           | $       | × 37% (0.37)      | $     | $ 30,930.00 | $
  value: ctx.forms["f1040"]["line.11b.taxable.income.whole"]
  calculate: |
    (ctx, value) => {
      let taxComputationWorksheetValue;
      // Tax Computation Worksheet (married filing separately)
      if (value >= 100000 && value < 160725) {
        taxComputationWorksheetValue = value * 0.24 - 5825.50;
      } else if (value >= 160725 && value < 204100) {
        taxComputationWorksheetValue = value * 0.32 - 18683.50;
      } else if (value >= 204100 && value < 306175) {
        taxComputationWorksheetValue = value * 0.35 - 24806.50;
      } else {
        taxComputationWorksheetValue = value * 0.37 - 30930.00;
      }
      // include this amount on the entry space on Form 1040 or 1040-SR, line 12a
      return { field: '76', fill: taxComputationWorksheetValue };
    }

line.12.b.whole:
  # Add Schedule 2, line 3, and line 12a and enter the total.  Note this value
  # on Schedule 2 is the AMT value from f6251.
  77:  ctx.forms["f1040"]["line.12.a.tax.whole"] +
    (ctx.forms["f6251"]["part.2.line.11.amt.whole"] || 0) # WARNING: needed

line.13.b.schedule.3.whole:
  # Add Schedule 3, line 7, and line 13a and enter the total
  79: ctx.forms["f1040s3"]["part.i.7.total.whole"]

line.14.whole:
  # Subtract line 13b from line 12b. If zero or less, enter -0-
  80: Math.max(0,
        ctx.forms["f1040"]["line.12.b.whole"]
        - ctx.forms["f1040"]["line.13.b.schedule.3.whole"]
      )

line.16.total.tax.whole:
  # Add lines 14 and 15. This is your total tax
  82: ctx.forms["f1040"]["line.14.whole"] + ctx.forms["f1040"]["line.15.whole"]

line.18.d.whole:
  # Schedule 3, line 14
  87: ctx.forms["f1040s3"]["part.ii.14.refundable.credits.total.whole"]

line.18.e.whole:
  # Add lines 18a through 18d. These are your total other payments and
  # refundable credits
  88: ctx.forms["f1040"]["line.18.a.whole"] +
    ctx.forms["f1040"]["line.18.b.whole"] +
    ctx.forms["f1040"]["line.18.c.whole"] +
    ctx.forms["f1040"]["line.18.d.whole"]

line.19.total.payments.whole:
  # Add lines 17 and 18e. These are your total payments
  89: ctx.forms["f1040"]["line.17.a.whole"] +
    ctx.forms["f1040"]["line.18.e.whole"]

line.23.amount.you.owe.whole:
  # Amount you owe. Subtract line 19 from line 16. For details on how to
  # pay, see instructions
  98: ctx.forms["f1040"]["line.16.total.tax.whole"] +
    ctx.forms["f1040"]["line.19.total.payments.whole"]

third.party.designee:
  # 100: 1 is "yes"
  # 101: 2 is "no"
  101: 2

occupation:
  105: ctx.occupation
